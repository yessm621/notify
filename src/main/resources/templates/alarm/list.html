<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ì•Œë¦¼</title>
</head>
<body>

<h2>ğŸ”” ì‹¤ì‹œê°„ ì•Œë¦¼</h2>

<!-- ì•Œë¦¼ ëª©ë¡ -->
<ul id="alarmList">
  <li th:each="alarm : ${alarms}" th:text="${alarm.text}">ì•Œë¦¼ ë‚´ìš©</li>
</ul>

<script>
  // ì•Œë¦¼ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¹„ë™ê¸°ë¡œ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
  function fetchAlarms() {
    console.log("fetchAlarms======");
    fetch('/user/alarm')
      .then(res => res.json())
      .then(data => {
        const alarmList = document.getElementById("alarmList");
        alarmList.innerHTML = ''; // ê¸°ì¡´ ì•Œë¦¼ ì§€ì›€
        data.result.content.forEach(alarm => {
          const li = document.createElement('li');
          li.textContent = alarm.text;
          alarmList.appendChild(li);
        });
      })
      .catch(err => {
        console.error('ì•Œë¦¼ ë¡œë“œ ì‹¤íŒ¨', err);
        //window.location.href = '/user/login';
      });
  }

  // SSE ì—°ê²°
  const eventSource = new EventSource('/user/alarm/subscribe');

  eventSource.addEventListener('open', function () {
    console.log("ğŸ”Œ SSE ì—°ê²°ë¨");
  });

  eventSource.addEventListener('alarm', function (event) {
    console.log("ğŸ“© ìƒˆë¡œìš´ ì•Œë¦¼ ìˆ˜ì‹ :", event.data);
    fetchAlarms(); // ìƒˆ ì•Œë¦¼ ë„ì°© â†’ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
  });

  eventSource.addEventListener('error', function (event) {
    console.error("âŒ SSE ì˜¤ë¥˜", event);
    eventSource.close();
  });

  // ìµœì´ˆ ë¡œë”© ì‹œ fetch
  fetchAlarms();
</script>

</body>
</html>
