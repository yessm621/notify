<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>알림</title>
</head>
<body>

<h2>🔔 실시간 알림</h2>

<!-- 알림 목록 -->
<ul id="alarmList">
  <li th:each="alarm : ${alarms}" th:text="${alarm.text}">알림 내용</li>
</ul>

<script>
  // 알림 리스트를 비동기로 다시 불러오기
  function fetchAlarms() {
    console.log("fetchAlarms======");
    fetch('/user/alarm')
      .then(res => res.json())
      .then(data => {
        const alarmList = document.getElementById("alarmList");
        alarmList.innerHTML = ''; // 기존 알림 지움
        data.result.content.forEach(alarm => {
          const li = document.createElement('li');
          li.textContent = alarm.text;
          alarmList.appendChild(li);
        });
      })
      .catch(err => {
        console.error('알림 로드 실패', err);
        //window.location.href = '/user/login';
      });
  }

  // SSE 연결
  const eventSource = new EventSource('/user/alarm/subscribe');

  eventSource.addEventListener('open', function () {
    console.log("🔌 SSE 연결됨");
  });

  eventSource.addEventListener('alarm', function (event) {
    console.log("📩 새로운 알림 수신:", event.data);
    fetchAlarms(); // 새 알림 도착 → 리스트 갱신
  });

  eventSource.addEventListener('error', function (event) {
    console.error("❌ SSE 오류", event);
    eventSource.close();
  });

  // 최초 로딩 시 fetch
  fetchAlarms();
</script>

</body>
</html>
